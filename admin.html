<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TacoTruck – Admin</title>
  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b;
      --card:#ffffff; --stroke:#e2e8f0; --stroke2:#eef2f7; --accent:#0ea5e9; --pill:#e2e8f0;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;font:14px system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
    h1{margin:0 0 12px;font-size:24px}
    h2{margin:24px 0 12px;font-size:18px;font-weight:600}
    h3{margin:20px 0 8px;font-size:16px;font-weight:600}
    
    /* Top metrics */
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
    .metric-card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:20px;text-align:center}
    .metric-value{font-size:48px;font-weight:700;color:var(--accent);line-height:1}
    .metric-label{font-size:13px;color:var(--muted);margin-top:8px;text-transform:uppercase;letter-spacing:0.5px}
    
    /* Main layout */
    .layout{display:grid;grid-template-columns:1fr 200px;gap:24px}
    .main-content{min-width:0}
    .sidebar{min-width:0}
    
    /* Buttons */
    button{padding:10px 14px;border:0;border-radius:8px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;font-size:14px}
    button.ghost{background:var(--pill);color:var(--fg)}
    button.danger{background:var(--danger);font-size:12px;padding:8px 12px}
    .button-group{display:flex;flex-direction:column;gap:8px}
    
    /* Tables */
    table{width:100%;border-collapse:collapse;background:var(--card);border:1px solid var(--stroke);border-radius:8px;overflow:hidden}
    th,td{padding:8px 10px;border-bottom:1px solid var(--stroke2);text-align:left;font-size:13px;vertical-align:top}
    th{background:#f1f5f9;font-weight:600}
    
    /* Disclaimer comparison table */
    .comparison-table{margin-bottom:32px}
    .comparison-table td{text-align:center}
    .comparison-table th{text-align:center}
    .variant-header{font-weight:700;font-size:14px}
    .step-label{text-align:left;font-weight:600;background:#f1f5f9}
    
    /* Timing bars */
    .timing-bar{height:24px;background:#e5e7eb;border-radius:4px;overflow:hidden;position:relative}
    .timing-bar-fill{height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;font-size:11px}
    
    /* Badges */
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#e2e8f0;font-size:12px;font-weight:600}
    .badge.ok{background:#dcfce7;color:#14532d}
    .badge.warn{background:#fef3c7;color:#78350f}
    
    /* Utility */
    .pill{background:var(--pill);border-radius:999px;padding:4px 10px;margin-left:6px}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .nowrap{white-space:nowrap}
    .truncate{max-width:520px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    pre{white-space:pre-wrap;background:var(--card);border:1px solid var(--stroke);border-radius:8px;padding:12px;max-height:40vh;overflow:auto;font-size:12px}
    
    /* Alert for single session */
    .alert{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px 16px;margin-bottom:24px;font-size:13px}
    .alert strong{color:#92400e}
  </style>
</head>
<body>
  <h1>TacoTruck Admin <span id="session" class="pill"></span></h1>
  
  <div class="alert">
    <strong>⚠️ Single Session View:</strong> This page shows data for the current browser session only. To aggregate data across all 50+ participants, use Google Sheets directly or create a dashboard that pulls from the Sheets API.
  </div>

  <!-- Top Metrics -->
  <div class="metrics">
    <div class="metric-card">
      <div class="metric-value" id="metricTotal">1</div>
      <div class="metric-label">Total Sessions</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="metricIndex">—</div>
      <div class="metric-label">Viewed Index</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="metricDisclaimer">—</div>
      <div class="metric-label">Completed Disclaimer</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="metricChatbot">—</div>
      <div class="metric-label">Used Chatbot</div>
    </div>
    <div class="metric-card">
      <div class="metric-value" id="metricSurvey">—</div>
      <div class="metric-label">Reached Survey</div>
    </div>
  </div>

  <div class="layout">
    <!-- Main Content -->
    <div class="main-content">
      
      <h2>Disclaimer Variant Comparison</h2>
      <table class="comparison-table">
        <thead>
          <tr>
            <th class="step-label">Step</th>
            <th class="variant-header">Variant A<br><span class="muted" style="font-weight:400;font-size:11px">Formal/Formal</span></th>
            <th class="variant-header">Variant B<br><span class="muted" style="font-weight:400;font-size:11px">Formal/Informal</span></th>
            <th class="variant-header">Variant C<br><span class="muted" style="font-weight:400;font-size:11px">Informal/Informal</span></th>
            <th class="variant-header">Variant D<br><span class="muted" style="font-weight:400;font-size:11px">Informal/Formal</span></th>
          </tr>
        </thead>
        <tbody id="comparisonBody">
          <!-- Populated by JavaScript -->
        </tbody>
      </table>
      <div class="muted" style="font-size:12px;margin-top:8px">
        * Times shown are for the current session only. For aggregated averages across all participants, analyse your Google Sheets data.
      </div>

      <h3>Summary</h3>
      <table id="summary"><tbody></tbody></table>

      <h3>Last 10 Events</h3>
      <table id="events">
        <thead>
          <tr>
            <th>When</th>
            <th>Type</th>
            <th>Disc</th>
            <th>Detail</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3>Raw Data (truncated)</h3>
      <pre id="raw"></pre>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
      <h3>Actions</h3>
      <div class="button-group">
        <button id="download">Download CSV</button>
        <button id="refresh" class="ghost">Refresh View</button>
        <button id="reset" class="danger">Reset Logs</button>
      </div>
    </div>
  </div>

  <script src="tt-logger.js"></script>
  <script>
    // --- helpers ---
    const fmt = (x) => typeof x==='string' ? x : JSON.stringify(x);
    function getLogs(){ try { return JSON.parse(localStorage.getItem('tt_logs')||'{}'); } catch { return {}; } }
    function getMeta(){ try { return JSON.parse(localStorage.getItem('tt_meta')||'{}'); } catch { return {}; } }
    const safeArr = (a) => Array.isArray(a) ? a : [];

    function prettyTs(ts){
      try {
        const d = typeof ts==='number' ? new Date(ts) : new Date(String(ts));
        if (isNaN(d.getTime())) return ts || '—';
        return d.toLocaleString();
      } catch { return ts || '—'; }
    }
    
    function msToStr(ms){
      if (!Number.isFinite(ms)) return '—';
      if (ms<1000) return ms+' ms';
      const s = ms/1000;
      if (s<60) return s.toFixed(1)+' s';
      const m = Math.floor(s/60);
      const r = (s%60).toFixed(0);
      return `${m}m ${r}s`;
    }

    // Aggregate disclaimer step times from events
    function aggregateDisclaimerSteps(events){
      const variants = {A:{}, B:{}, C:{}, D:{}};
      
      events.forEach(e => {
        if (e.type === 'disclaimer_step_complete' && e.disc && e.step && e.duration_ms){
          const variant = e.disc;
          const step = e.step;
          if (!variants[variant][step]) variants[variant][step] = [];
          variants[variant][step].push(e.duration_ms);
        }
      });
      
      // Calculate averages
      const result = {A:{}, B:{}, C:{}, D:{}};
      for (const variant in variants){
        for (const step in variants[variant]){
          const times = variants[variant][step];
          const avg = times.reduce((a,b)=>a+b,0) / times.length;
          result[variant][step] = {avg, count: times.length};
        }
      }
      
      return result;
    }

    // Calculate metrics
    function calculateMetrics(events){
      const metrics = {
        total: 1, // Current session
        index: 0,
        disclaimer: 0,
        chatbot: 0,
        survey: 0
      };
      
      events.forEach(e => {
        if (e.path && e.path.includes('index.html')) metrics.index = 1;
        if (e.type === 'disclaimer_complete' || e.type === 'disclaimer_step_complete') metrics.disclaimer = 1;
        if (e.type === 'chat_start' || e.type === 'chat_user_turn') metrics.chatbot = 1;
        if (e.type === 'survey_redirect') metrics.survey = 1;
      });
      
      return metrics;
    }

    // --- main render ---
    function render(){
      const s = getLogs();
      const m = getMeta();
      const events = safeArr(s.events).filter(e => {
        // Filter out admin page views
        return !(e.type === 'page_view' && e.path && e.path.includes('admin.html'));
      });

      // Session pill
      document.getElementById('session').textContent = s.session_id || '(none)';

      // Metrics
      const metrics = calculateMetrics(events);
      document.getElementById('metricTotal').textContent = metrics.total;
      document.getElementById('metricIndex').textContent = metrics.index || '—';
      document.getElementById('metricDisclaimer').textContent = metrics.disclaimer || '—';
      document.getElementById('metricChatbot').textContent = metrics.chatbot || '—';
      document.getElementById('metricSurvey').textContent = metrics.survey || '—';

      // Disclaimer comparison
      const stepData = aggregateDisclaimerSteps(events);
      const comparisonBody = document.getElementById('comparisonBody');
      comparisonBody.innerHTML = '';
      
      // Get max step number
      const allSteps = new Set();
      ['A','B','C','D'].forEach(v => {
        Object.keys(stepData[v]).forEach(s => allSteps.add(parseInt(s)));
      });
      const maxStep = allSteps.size > 0 ? Math.max(...allSteps) : 4;
      
      // Find max time for bar scaling
      let maxTime = 0;
      ['A','B','C','D'].forEach(v => {
        for(let step=1; step<=maxStep; step++){
          if(stepData[v][step]) maxTime = Math.max(maxTime, stepData[v][step].avg);
        }
      });
      
      // Create rows
      for(let step=1; step<=maxStep; step++){
        const tr = document.createElement('tr');
        
        // Step label
        const tdLabel = document.createElement('td');
        tdLabel.className = 'step-label';
        tdLabel.textContent = `Step ${step}`;
        tr.appendChild(tdLabel);
        
        // Variant columns
        ['A','B','C','D'].forEach(variant => {
          const td = document.createElement('td');
          if(stepData[variant][step]){
            const ms = stepData[variant][step].avg;
            const pct = maxTime > 0 ? Math.max(10, (ms/maxTime)*100) : 0;
            td.innerHTML = `
              <div class="timing-bar">
                <div class="timing-bar-fill" style="width:${pct}%">${msToStr(ms)}</div>
              </div>
            `;
          } else {
            td.innerHTML = '<span class="muted">—</span>';
          }
          tr.appendChild(td);
        });
        
        comparisonBody.appendChild(tr);
      }
      
      // Add total row
      const trTotal = document.createElement('tr');
      const tdTotalLabel = document.createElement('td');
      tdTotalLabel.className = 'step-label';
      tdTotalLabel.innerHTML = '<strong>Total</strong>';
      trTotal.appendChild(tdTotalLabel);
      
      ['A','B','C','D'].forEach(variant => {
        const td = document.createElement('td');
        let total = 0;
        for(let step=1; step<=maxStep; step++){
          if(stepData[variant][step]) total += stepData[variant][step].avg;
        }
        if(total > 0){
          const badgeClass = total >= 60000 ? 'warn' : 'ok';
          td.innerHTML = `<strong><span class="badge ${badgeClass}">${msToStr(total)}</span></strong>`;
        } else {
          td.innerHTML = '<span class="muted">—</span>';
        }
        tr.appendChild(td);
      });
      
      comparisonBody.appendChild(trTotal);

      // Summary
      const sum = document.querySelector('#summary tbody');
      sum.innerHTML = '';
      [
        ['Session ID', s.session_id || '—'],
        ['Started at', prettyTs(s.started_at) || '—'],
        ['Events (excl. admin)', events.length],
        ['Disclaimer variant', m.disc || '(unknown)'],
      ].forEach(([k,v])=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<th>${k}</th><td>${fmt(v)}</td>`;
        sum.appendChild(tr);
      });

      // Last 10 events
      const evBody = document.querySelector('#events tbody');
      evBody.innerHTML = '';
      events.slice(-10).reverse().forEach(e=>{
        const tr=document.createElement('tr');

        // When
        const tdWhen = document.createElement('td');
        tdWhen.innerHTML = `${prettyTs(e.ts)}<div class="muted mono">${e.ts ?? ''}</div>`;
        tr.appendChild(tdWhen);

        // Type
        const tdType = document.createElement('td');
        tdType.textContent = e.type || '';
        tr.appendChild(tdType);

        // Disc
        const tdDisc = document.createElement('td');
        tdDisc.textContent = e.disc ?? '';
        tr.appendChild(tdDisc);

        // Detail
        const tdDet = document.createElement('td');
        const keysToShow = ['path','test_number','intent','category','rating','seconds','rt_ms','duration_ms','step'];
        const parts = [];
        keysToShow.forEach(k=>{
          if (e[k] !== undefined) parts.push(`<span class="mono">${k}</span>: ${fmt(e[k])}`);
        });
        const compact = parts.join(' · ');
        tdDet.innerHTML = compact ? `<div class="truncate" title='${fmt(e)}'>${compact}</div>` : `<span class="muted">—</span>`;
        tr.appendChild(tdDet);

        evBody.appendChild(tr);
      });

      // Raw
      const raw = JSON.stringify(s);
      document.getElementById('raw').textContent = raw.length>5000 ? raw.slice(0,5000)+' …(truncated)' : raw;
    }

    // Buttons
    document.getElementById('download').onclick = () => TTLOG.exportCSV();
    document.getElementById('refresh').onclick = render;
    document.getElementById('reset').onclick = () => {
      if(confirm('⚠️ Are you sure you want to delete ALL logged data for this session? This cannot be undone!')){
        localStorage.removeItem('tt_logs');
        localStorage.removeItem('tt_meta');
        alert('✓ Logs reset successfully');
        render();
      }
    };

    render();
  </script>
</body>
</html>
