<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TacoTruck â€“ Test Runner</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Inter,Arial;margin:0;background:#fff}
    header{padding:14px 18px;border-bottom:1px solid #e5e7eb}
    main{max-width:920px;margin:0 auto;padding:18px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px}
    .row{display:flex;gap:12px;align-items:center}
    .actions{display:flex;gap:8px;margin-top:12px}
    button{padding:10px 14px;border:0;border-radius:8px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:#f1f5f9;color:#0f172a}
    .muted{color:#64748b}
    iframe{width:100%;height:360px;border:1px solid #e5e7eb;border-radius:10px}
    .hidden{display:none}
    .pill{background:#f1f5f9;color:#334155;border-radius:999px;padding:4px 10px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <strong>TacoTruck Runner</strong>
    <span id="sessionId" class="pill" style="margin-left:8px"></span>
  </header>
  <main>
    <!-- Step 1: Disclaimer -->
    <section id="stepDisclaimer" class="card">
      <h2>Step 1 â€” Disclaimer</h2>
      <p class="muted">We assigned a version at random. Please read the disclaimer and click â€œI acceptâ€.</p>
      <p>Assigned version: <strong id="discVersion">â€”</strong></p>
      <iframe id="discFrame" src="" title="Disclaimer"></iframe>
      <div class="actions">
        <button id="acceptDisclaimer">I accept</button>
      </div>
    </section>

    <!-- Step 2: Chatbot test placeholder -->
    <section id="stepChat" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <h2>Step 2 â€” Chatbot Test <span id="testCounter" class="pill">Test 1 of 5</span></h2>
        <button id="endEarly" class="ghost">End testing</button>
      </div>
      <p><strong>Suggestion:</strong> <span id="suggestion">â€”</span></p>
      <div class="row">
        <input id="userInput" type="text" placeholder="Type your questionâ€¦" style="flex:1;padding:10px;border:1px solid #cbd5e1;border-radius:8px"/>
        <button id="sendMsg">Send</button>
      </div>
      <div id="chatLog" style="margin-top:10px"></div>
      <div class="actions">
        <button id="followUp" class="ghost">Ask follow-up</button>
        <button id="rateNext">Rate &amp; next</button>
      </div>
      <div id="ratingRow" class="hidden" style="margin-top:10px">
        <span>Rate this conversation: </span>
        <button class="ghost" data-rate="1">ğŸ‘</button>
        <button class="ghost" data-rate="-1">ğŸ‘</button>
        <button class="ghost" data-rate="0">ğŸ¤·</button>
      </div>
    </section>

    <!-- Step 3: Done -->
    <section id="stepDone" class="card hidden">
      <h2>All done â€” thank you!</h2>
      <p>Youâ€™ve completed all 5 tests.</p>
      <div class="actions">
        <a class="ghost" href="https://qualtrics.example.com/survey-link" target="_blank" rel="noopener">Complete short survey</a>
        <button id="restart" class="ghost">Start over</button>
      </div>
    </section>
  </main>

  <script>
    // --------------------------
    // Minimal â€œstateâ€ + logging
    // --------------------------
    const SUGGESTIONS = [
      "Ask how to revive an expired trade mark",
      "Ask why two similar trade marks are both registered",
      "Ask how to request an online takedown",
      "Ask what â€˜noveltyâ€™ means for patents",
      "Ask when to send a cease & desist"
    ];
    const VERSIONS = ["A","B","C","D"];

    function nowISO(){ return new Date().toISOString(); }
    function newSessionId(){ return 'tt_' + Math.random().toString(36).slice(2,10); }

    function getLogs(){
      try { return JSON.parse(localStorage.getItem('tt_logs')||'{}'); }
      catch { return {}; }
    }
    function setLogs(obj){
      localStorage.setItem('tt_logs', JSON.stringify(obj));
    }
    function pushEvent(e){
      const logs = getLogs();
      if(!logs.events) logs.events = [];
      logs.events.push(e);
      setLogs(logs);
    }

    // --------------------------
    // Session init
    // --------------------------
    const sessEl = document.getElementById('sessionId');
    const discVersionEl = document.getElementById('discVersion');
    const discFrame = document.getElementById('discFrame');
    const stepDisclaimer = document.getElementById('stepDisclaimer');
    const stepChat = document.getElementById('stepChat');
    const stepDone = document.getElementById('stepDone');

    const acceptBtn = document.getElementById('acceptDisclaimer');
    const endEarly = document.getElementById('endEarly');
    const restart = document.getElementById('restart');

    const testCounter = document.getElementById('testCounter');
    const suggestionEl = document.getElementById('suggestion');
    const userInput = document.getElementById('userInput');
    const sendMsg = document.getElementById('sendMsg');
    const chatLog = document.getElementById('chatLog');
    const followUp = document.getElementById('followUp');
    const rateNext = document.getElementById('rateNext');
    const ratingRow = document.getElementById('ratingRow');

    let session_id, disclaimerVersion, discStart, testIndex=1, turn=0, followups=0;
    let currentSuggestion = "";

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    function startSession(){
      const logs = { session_id:newSessionId(), started_at:nowISO(), events:[] };
      setLogs(logs);
      session_id = logs.session_id;
      sessEl.textContent = session_id;

      // assign disclaimer
      disclaimerVersion = VERSIONS[Math.floor(Math.random()*VERSIONS.length)];
      discVersionEl.textContent = disclaimerVersion;
      discFrame.src = `./disclaimers/disclaimer${disclaimerVersion}.html`;

      discStart = Date.now();
      pushEvent({type:'disclaimer_shown', session_id, version:disclaimerVersion, ts:nowISO()});
    }

    // --------------------------
    // Disclaimer acceptance
    // --------------------------
    acceptBtn.addEventListener('click', ()=>{
      const discEnd = Date.now();
      const seconds = Math.round((discEnd - discStart)/1000);
      pushEvent({type:'disclaimer_accepted', session_id, version:disclaimerVersion, seconds, ts:nowISO()});
      hide(stepDisclaimer);
      startTestLoop();
    });

    // --------------------------
    // Test loop (placeholder)
    // --------------------------
    function startTestLoop(){
      show(stepChat);
      setupTest();
    }

    function setupTest(){
      if(testIndex>5){
        hide(stepChat); show(stepDone);
        pushEvent({type:'tests_completed', session_id, total:5, ts:nowISO()});
        return;
      }
      testCounter.textContent = `Test ${testIndex} of 5`;
      currentSuggestion = SUGGESTIONS[(testIndex-1)%SUGGESTIONS.length];
      suggestionEl.textContent = currentSuggestion;
      userInput.value = '';
      chatLog.innerHTML = '';
      turn = 0; followups = 0;
      ratingRow.classList.add('hidden');
      pushEvent({type:'test_setup', session_id, test_number:testIndex, suggestion:currentSuggestion, ts:nowISO()});
    }

    function addChat(role, text){
      const row = document.createElement('div');
      row.textContent = (role==='user'?'You: ':'Bot: ') + text;
      chatLog.appendChild(row);
    }

    sendMsg.addEventListener('click', ()=>{
      const text = (userInput.value||'').trim();
      if(!text) return;
      turn += 1;
      addChat('user', text);
      pushEvent({type:'turn', session_id, test_number:testIndex, turn, role:'user', message:text, ts:nowISO()});

      // placeholder bot message (no AI yet)
      const botStart = performance.now();
      setTimeout(()=>{
        const botMsg = `Outline-only placeholder for: "${text}"`;
        addChat('bot', botMsg);
        const rt = Math.round(performance.now() - botStart);
        pushEvent({type:'turn', session_id, test_number:testIndex, turn, role:'bot', message:botMsg, response_time_ms:rt, ts:nowISO()});
      }, 400);

      userInput.value = '';
    });

    followUp.addEventListener('click', ()=>{
      followups += 1;
      if(followups>=2){ followUp.disabled = true; }
      // just enables more user input; logging is handled on send
    });

    rateNext.addEventListener('click', ()=>{
      ratingRow.classList.remove('hidden');
    });

    ratingRow.addEventListener('click', (e)=>{
      const v = e.target?.getAttribute?.('data-rate');
      if(v===null || v===undefined) return;
      const val = Number(v);
      pushEvent({type:'rating', session_id, test_number:testIndex, rating:val, ts:nowISO()});
      // next test
      testIndex += 1;
      setupTest();
    });

    endEarly.addEventListener('click', ()=>{
      pushEvent({type:'abandoned', session_id, at_test:testIndex, ts:nowISO()});
      hide(stepChat); show(stepDone);
    });

    restart.addEventListener('click', ()=>{
      localStorage.removeItem('tt_logs');
      location.href = 'index.html';
    });

    // Start
    startSession();
  </script>
</body>
</html>

