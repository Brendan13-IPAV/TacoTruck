
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TacoTruck â€“ Runner</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #fff; }
    /* Full-bleed iframe */
    #frame {
      display: block;
      width: 100vw;
      height: 100vh;
      border: 0;
    }
    /* Tiny, hidden error bar that only shows if something goes wrong */
    #err {
      position: fixed; inset: 0 0 auto 0;
      display: none; padding: 8px 12px;
      background: #fee2e2; color: #7f1d1d; font: 13px system-ui,Segoe UI,Roboto,Inter,Arial;
      border-bottom: 1px solid #fecaca; z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="err"></div>
  <iframe id="frame" title="Disclaimer"></iframe>

  <!-- Local telemetry logger (kept as-is) -->
  <script src="../tt-logger.js"></script>

  <script>
/* ===========================
   Google Sheet logging (minimal)
   =========================== */
const LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbwP-BtZ-hwjFrHK0wgcgis31GQuF3YARMj9Mzja1DVLQ5vy3iPRSPZEaIpje0epjjU7/exec";  // your Web App URL

async function sendLog(payload) {
  try {
    await fetch(LOG_ENDPOINT, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  } catch (err) {
    console.error("Log error:", err);
  }
}

// helpers to add session/disclaimer context automatically
function getSessionId() {
  try { return JSON.parse(localStorage.getItem('tt_logs')||'{}').session_id || ''; }
  catch { return ''; }
}
function withCtx(extra) {
  const disc = (JSON.parse(localStorage.getItem('tt_meta')||'{}').disc) || '';
  return { ts: new Date().toISOString(), session_id: getSessionId(), disc, ...extra };
}

// log that runner loaded
sendLog(withCtx({ event: 'runner_loaded' }));


/* ===========================
   Runner core (kept minimal)
   =========================== */

// Map the actual files you have in GitHub (html or txt both fine)
const CANDIDATES = [
  { id: 'A', url: './disclaimers/disclaimerA.html' }, 
  { id: 'B', url: './disclaimers/disclaimerB.html' },
  { id: 'C', url: './disclaimers/disclaimerC.html' },
  { id: 'D', url: './disclaimers/disclaimerD.html' },
];

const err = document.getElementById('err');
const frame = document.getElementById('frame');

function showError(msg){
  err.textContent = msg;
  err.style.display = 'block';
}

// Helper: read ?v=A to force a specific version for QA
function getForcedVersion(){
  const v = new URLSearchParams(location.search).get('v');
  return v && /^[ABCD]$/i.test(v) ? v.toUpperCase() : null;
}

async function pickAvailable(candidates) {
  // If a version is forced, probe only that one
  const forced = getForcedVersion();
  if (forced) sendLog(withCtx({ event: 'disclaimer_forced', forced }));

  const pool = forced
    ? candidates.filter(c => c.id === forced)
    : candidates.slice();

  // Probe each candidate (HEAD is unreliable on GitHub Pages; GET and discard)
  const checks = await Promise.all(pool.map(async c => {
    try {
      const res = await fetch(c.url, { cache: 'no-store' });
      return res.ok ? c : null;
    } catch { return null; }
  }));

  const available = checks.filter(Boolean);
  if (available.length === 0) return null;
  return available[Math.floor(Math.random()*available.length)];
}

(async function init(){
  const chosen = await pickAvailable(CANDIDATES);

  if (!chosen) {
    showError('No disclaimer file could be loaded. Check filenames/paths in /disclaimers.');
    sendLog(withCtx({ event: 'disclaimer_assign_failed' }));
    return;
  }

  // Save assigned version now that we know we have one
  localStorage.setItem('tt_meta', JSON.stringify({ disc: chosen.id }));
  sendLog(withCtx({ event: 'disclaimer_assigned', version: chosen.id }));

  // Load the disclaimer; it owns the interaction and can navigate to ChatBot.html itself
  frame.src = chosen.url;

  frame.addEventListener('load', () => {
    try {
      localStorage.setItem('tt_disc_start', String(Date.now()));
      if (window.TTLOG) TTLOG.push('disclaimer_start', { version: chosen.id });
      sendLog(withCtx({ event: 'disclaimer_loaded', version: chosen.id, url: chosen.url }));
    } catch (_) {}
  });
})();

// Optional: if your disclaimers want to signal completion, support postMessage:
// inside the disclaimer, you can post: window.parent.postMessage({type:'DONE'}, '*')
// and the runner will navigate to ChatBot.html
window.addEventListener('message', (e) => {
  if (e?.data?.type === 'DONE') {
    sendLog(withCtx({ event: 'disclaimer_done_redirect' }));
    window.location.href = 'ChatBot.html';
  }
});
  </script>
</body>
</html>
