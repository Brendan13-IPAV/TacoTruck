<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="color-scheme" content="light dark" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <title>TacoTruck ‚Äì ChatBot Prototype</title>

  <!-- note qualtrix link is https://ipaustralia.au1.qualtrics.com/jfe/form/SV_6g5ub3M5I2WGnf8 -->

  <!-- Accessibility / UX: high-contrast defaults, system fonts, reduced motion respect -->
<style>
  :root{
    --bg:#ffffff;
    --bg-grad: linear-gradient(135deg,#f8fafc 0%, #fff7ed 100%);
    --ink:#0f172a;
    --muted:#475569;
    --border: rgba(2,6,23,0.12);
    --pill:#e2e8f0;
    --accentA:#0ea5e9;
    --accentB:#0284c7;
    --cta:#0ea5e9;
    --cta-contrast:#ffffff;
    --danger:#b91c1c;
  }

  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1220;
      --bg-grad: linear-gradient(135deg,#0b1220 0%, #0f172a 100%);
      --ink:#e5eef9;
      --muted:#a3b2c7;
      --border: rgba(229,238,249,0.14);
      --pill:#1f2a3d;
      --accentA:#38bdf8;
      --accentB:#0ea5e9;
      --cta:#38bdf8;
      --cta-contrast:#0b1220;
    }
  }

  *{ box-sizing:border-box }

  html{
    overflow-y: scroll;                 /* keep scrollbar space */
    scrollbar-gutter: stable both-edges;/* stop layout nudge when content grows */
  }

  html,body{ height:100% }

  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    color:var(--ink);
    background:var(--bg-grad);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Header */
  header{
    display:flex; align-items:center; gap:12px;
    padding:12px 16px; border-bottom:1px solid var(--border);
    background: color-mix(in oklab, var(--bg) 92%, transparent);
  }
  .brand{
    display:grid; place-items:center; width:40px; height:40px; border-radius:12px;
    background: linear-gradient(135deg, var(--accentA), var(--accentB));
    color:#fff; font-weight:700; font-size:20px;
  }
  .headtext{ display:flex; flex-direction:column }
  .title{ margin:0; font-size:18px; letter-spacing:-0.1px }
  .subtitle{ margin:0; font-size:13px; color:var(--muted) }
  .session{
    margin-left:auto; font-size:12px; padding:4px 10px; border-radius:999px;
    background:var(--pill); color:var(--ink); white-space:nowrap;
  }

  /* Main layout */
  main{
    height:calc(100% - 57px);
    display:flex; justify-content:center; align-items:stretch;
    padding:12px;
  }
  .layout{
    height: calc(50% - 57px);
    display:grid;
    grid-template-columns: 340px 1fr; /* left fixed, right fills */
    gap:24px;
    padding:24px;
    max-width:2000px;
    margin:0 auto;
  }
  @media (max-width: 900px){
    .layout{ grid-template-columns: 1fr; }
    .panel{ order:-1; } /* panel above chat on mobile */
  }

  /* Left panel */
  .panel{
    background: linear-gradient(135deg, #fef3c7 0%, #dbeafe 100%);
    border: 2px solid var(--accentA);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
  }
  .panel-title{
    font-weight:700; font-size:13px; color:var(--accentB);
    text-transform:uppercase; letter-spacing:.05em; margin-bottom:8px;
  }
  .panel .muted{ color:var(--muted) }
  .small{ font-size:12px }

  .panel-box{
    background:white;
    border:2px dashed var(--accentA);
    border-radius:10px;
    padding:8px;               /* tighter to fit content */
    margin-bottom:16px;        /* was 24px */
  }

  /* Compact ‚ÄúTest progress‚Äù row */
  #testStatus{
    display:inline-flex;
    align-items:baseline;
    gap:8px;
    padding:6px 10px;          /* was 12px */
    line-height:1.2;
  }
  #testStatus strong{ margin:0 }
  #testHint{
    margin:0;
    white-space:nowrap;        /* prevents awkward wrap */
  }

  /* Chat card */
  .wrap{
    width:min(960px,100%);
    min-width:600px;
  }
  .card{
    display:flex; flex-direction:column; min-height:0;
    background: color-mix(in oklab, var(--bg) 96%, transparent);
    border:1px solid var(--border); border-radius:14px;
    box-shadow:0 10px 30px rgba(2,6,23,0.05);
    overflow:hidden;
  }

  /* Messages */
  .messages{
    flex:1; min-height:260px; max-height:72vh;
    overflow-y:scroll; padding:14px;
    background: color-mix(in oklab, var(--bg) 98%, transparent);
  }
  .row{ display:flex; margin:8px 0 }
  .row.user{ justify-content:flex-end }
  .bubble{
    max-width:85%; padding:10px 14px; border-radius:12px;
    font-size:14px; line-height:1.6; white-space:pre-wrap;
    border:1px solid var(--border);
    background:var(--bg); color:var(--ink);
  }
  .row.user .bubble{
    border:0; color:var(--cta-contrast);
    background: linear-gradient(135deg, var(--accentA), var(--accentB));
  }
  .visually-hidden{
    position:absolute !important; height:1px; width:1px;
    overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; border:0; padding:0; margin:-1px;
  }

  /* Footer / controls */
  .footer{ border-top:1px solid var(--border); background:var(--bg); padding:12px }
  .controls{ display:flex; gap:10px; align-items:flex-start }
  textarea{
    flex:1; resize:none; border:1px solid var(--border); border-radius:10px;
    padding:10px 12px; color:var(--ink); background:var(--bg);
  }
  textarea:focus{ outline:3px solid color-mix(in oklab, var(--accentA) 25%, transparent) }
  button{
    border:0; border-radius:10px; padding:10px 14px; font-weight:600; cursor:pointer;
  }
  .send{ background:var(--cta); color:var(--cta-contrast) }
  .secondary{ background:var(--pill); color:var(--ink) }
  .hint{ margin-top:6px; font-size:12px; color:var(--muted); text-align:center }

  /* Intent rating row */
  #ratingRow{
    background: color-mix(in oklab, var(--accentA) 8%, var(--bg));
    border:2px solid var(--accentA);
    border-radius:12px;
    padding:16px !important;
    margin:12px 0;
    display:flex;
    flex-direction:column;
    gap:12px !important;
    align-items:center;
    justify-content:center;
    min-height:120px; /* reserve space to prevent reflow */
  }
  #ratingRow span{
    font-weight:600;
    font-size:16px;
    color:var(--muted);
  }
  .rating-buttons{
    display:inline-flex;   /* prevents text shifting when Next button appears */
    align-items:center;
    gap:14px;
    min-width:180px;       /* tiny floor to keep width stable */
    justify-content:center;
  }

  /* Rating buttons */
  .rateBtn{
    background:var(--pill);
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 16px;
    font-size:24px;        /* larger emoji */
    cursor:pointer;
    transition: background 0.2s, transform 0.2s;
  }
  .rateBtn:hover{
    background: color-mix(in oklab, var(--accentA) 15%, var(--pill));
    transform: translateY(-2px);
  }
  .rateBtn:active{ transform: translateY(0) }
  .rateBtn.selected{
    background:var(--accentA);
    color:#fff;
    transform: scale(1.1);
  }
  .rateBtn.dimmed{
    opacity:.3;
    pointer-events:none;
  }

  /* Utility */
  .actions-center{
    display:flex; justify-content:center; margin-top:16px; /* was 200px inline */
  }
  .fineprint{ margin:0; text-align:center; font-size:12px; color:var(--muted) }
  .btn-link{
    background:none; border:none; color:var(--accentB); text-decoration:underline; cursor:pointer;
    padding:0 4px; font:inherit;
  }
  .spinner{
    width:16px; height:16px; border:2px solid currentColor; border-top-color:transparent;
    border-radius:50%; animation: spin .9s linear infinite; margin-right:8px;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* Minor helper animations */
  @keyframes flashClear {
    0%,100%{ opacity:1 }
    50%{ opacity:.3 }
  }
  .clearing{ animation: flashClear .4s ease-in-out }

  /* ===== PATCH: keep layout width stable and shrink rating row ===== */

/* 1) Grid never shrinks the chat column when internals gain a scrollbar */
.layout { grid-template-columns: 340px minmax(600px, 1fr); }

/* 2) The messages area keeps a stable scrollbar gutter (prevents tiny nudges) */
.messages {
  scrollbar-gutter: stable both-edges;
  overflow-y: auto; /* unchanged behavior, just explicit */
}

/* 3) Make the rating question + buttons smaller and shorter overall */
#ratingRow {
  padding: 10px 12px !important;  /* tighter */
  gap: 8px !important;
  min-height: 100px;              /* lower than 120px */
  max-width: 900px;               /* don‚Äôt sprawl across full width */
  margin-inline: auto;            /* center the smaller block */
}
#ratingRow span {
  font-size: 15px;                /* was 24px inline; this is the new size */
  line-height: 1.25;
  font-weight: 600;
}
.rating-buttons {
  gap: 10px;
  min-width: 0;                   /* don‚Äôt force width */
}
.rateBtn {
  padding: 8px 12px;
  font-size: 20px;                /* smaller emoji/buttons */
}

/* 4) Keep ‚ÄúTest 1 of 5‚Äù on one line and stop the hint wrapping */
#testStatus {
  display: inline-flex;
  align-items: baseline;
  gap: 8px;
  flex-wrap: nowrap;              /* no wrapping inside the status row */
}
#testStatus strong,
#testHint { white-space: nowrap; }

</style>

</head>

<body>
  <a href="#composer" class="visually-hidden">Skip to message composer</a>

  <header role="banner" aria-label="Header">
    <div class="brand" aria-hidden="true">üåÆ</div>
    <div class="headtext">
      <h1 class="title">TacoTruck ChatBot</h1>
      <p class="subtitle">Australian IP question tester (prototype)</p>
    </div>
    <span id="sessionPill" class="session" aria-label="Session ID"></span>
  </header>

<main role="main">
  <div class="layout">
    <!-- LEFT: test panel (separate from chat) -->
    <aside class="panel" aria-label="Test instructions">
      <div class="panel-section">
        <div class="panel-title">Test progress</div>
        <div id="testStatus" class="panel-box">
          <strong id="testCounter">Test 1 of 5</strong>
          <div id="testHint" class="muted"></div>
        </div>
      </div>

      <div class="panel-section">
        <div class="panel-title">Topic idea</div>
        <div id="suggestionWrap" class="panel-box" style="display:none;">
          <em id="suggestionText"></em>
          <p class="muted small" style="margin:8px 0 0">
            How would a real user ask about this? Don't copy this text.
          </p>
        </div>
      </div>
    </aside>

    <!-- RIGHT: chat UI (unchanged) -->
    <section class="wrap">
      <section class="card" role="region" aria-label="Chat window">
        <!-- live region for assistive tech; assistant messages announced politely -->
        <div id="live" class="visually-hidden" aria-live="polite" aria-atomic="false"></div>

        <div id="messages" class="messages" tabindex="0"></div>

 <div class="footer">
          <div class="controls">
            <label for="input" class="visually-hidden">Your message</label>
            <textarea id="input" rows="2" placeholder="Ask your question as a user here." aria-label="Type your question"></textarea>
            <div style="display:flex; flex-direction:column; gap:8px;">
              <button id="send" class="send" aria-label="Send message">Send</button>
              <button id="clear" class="secondary" aria-label="Clear conversation">Clear</button>
            </div>
      </section>
<div id="ratingRow" style="visibility:hidden;display:flex;gap:14px;justify-content:center;align-items:center;padding:12px 0;">
  <span>How well did the bot understand your intent?</span>
  <div class="rating-buttons">
    <button class="rateBtn" data-rate="-1" aria-label="Bad (thumbs down)">üëé</button>
    <button class="rateBtn" data-rate="0"  aria-label="Neutral">üòê</button>
    <button class="rateBtn" data-rate="1"  aria-label="Good (thumbs up)">üëç</button>
    <button id="nextTest" class="send" style="display:none;font-size:14px;">Next test</button>
  </div>
  </div>
            
<div class="actions-center">

        <button id="surveyBtn" class="secondary" aria-label="Finish and take survey">Finish &amp; take survey</button>
      </div>
      <p class="fineprint" role="note">
        Prototype only ‚Äî this does not provide accurate information, and especially does not provide legal advice.
      </p>
    </section>
  </div>
</main>

      <p class="fineprint" role="note">
        Prototype only ‚Äî this does not provide accurate information, and especially does not provide legal advice.
      </p>
    </section>
  </div>
</main>


  <!-- Telemetry logger -->
  <script src="config.js"></script>
  <script src="tt-logger.js"></script>

  <!-- Outline-only placeholder: replace or augment later with topic lookup / API -->
  <script>

    
// ----- REAL API CONNECTION -----

async function getReplyDemo(userText) {
  

  const apiUrl = TACO_CONFIG.SCRIPT_URL;

  try {
    // 2. Send the message to Google Script using the dynamic 'apiUrl'
    const res = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' }, // avoids CORS errors
      body: JSON.stringify({ message: userText })
    });

    // 3. Check network status
    if (!res.ok) {
      throw new Error(`Server returned ${res.status} ${res.statusText}`);
    }

    // 4. Get the answer
    const data = await res.json();
    return data.reply || 'No response text received.';

  } catch (err) {
    console.error("Chat Error:", err);
    return "‚ö†Ô∏è Connection Error: " + err.message;
  }
}
    
// ---- Topic suggestions (loaded from /data/topics.json) ----
let TOPICS = [];
let currentSuggestion = null;

const suggestionWrap = document.getElementById('suggestionWrap');
const suggestionText = document.getElementById('suggestionText');


async function loadTopics() {
  try {
    const res = await fetch('topics.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('topics fetch failed');
    TOPICS = await res.json();
  } catch {
    // Fallback if file missing or blocked
TOPICS = [
  { topic:'Your choice!', suggestion:'Ask anything you want!' }
];

  }
}

// Pick and show a random suggestion for the current test
function setRandomSuggestionForTest() {
  if (!TOPICS.length) { 
    suggestionWrap.style.display = 'none'; 
    return; 
  }

  // 1. Pick a random item
  currentSuggestion = TOPICS[Math.floor(Math.random() * TOPICS.length)];

  // 2. Update the text on screen
  // We use the new "suggestion" field from your JSON
  suggestionText.textContent = currentSuggestion.suggestion || "Ask a random question about IP.";
  
  suggestionWrap.style.display = 'block';

  // 3. Log what was suggested (so you know what they were prompted to ask)
  if (window.TTLOG) {
    TTLOG.push('test_suggestion', {
      test_number: testIndex,
      topic_id: currentSuggestion.topic,  // Logs the Topic ID (Col A)
      suggestion_text: currentSuggestion.suggestion 
    });
  }
}



    
// ----- Test loop state -----
const TOTAL_TESTS = 5;
let testIndex = 1;
let turnsThisTest = 0;

// Optional: prompts you plan to show per test (leave blank if you don't want hints)
const TEST_HINTS = [
  "Try a cost/timing style question",
  "Ask about renewal/expiry",
  "Ask about takedowns/enforcement",
  "Ask about differences between IP rights",
  "Ask about international scope"
];

const testCounterEl = document.getElementById('testCounter');
const testHintEl = document.getElementById('testHint');
const ratingRow = document.getElementById('ratingRow');
const nextTestBtn = document.getElementById('nextTest');

// Prepare the UI for a given test
function setupTest() {
  testCounterEl.textContent = `Test ${testIndex} of ${TOTAL_TESTS}`;
  testHintEl.textContent = TEST_HINTS[testIndex - 1] ? `‚Ä¢ ${TEST_HINTS[testIndex - 1]}` : '';
  turnsThisTest = 0;
ratingRow.style.visibility = 'hidden';
  nextTestBtn.style.display = 'none';

  // NEW: Remove selected/dimmed states
  document.querySelectorAll('.rateBtn').forEach(b => {
    b.classList.remove('selected', 'dimmed');
  });
  
  if (window.TTLOG) TTLOG.push('test_setup', { test_number: testIndex });
  resetConversation();

  // NEW: display a random suggestion for this test
    setRandomSuggestionForTest();
}

// After at least one user ‚Üí bot exchange, show the rating
function maybeShowRating() {
  if (turnsThisTest > 0) {
    ratingRow.style.visibility = 'visible';
  }
}

// Handle rating click (+1 / 0 / ‚àí1)
ratingRow.addEventListener('click', (e) => {
  const btn = e.target.closest('.rateBtn');
  if (!btn) return;


  const val = Number(btn.getAttribute('data-rate'));
  if (window.TTLOG) TTLOG.push('test_rating', { test_number: testIndex, rating: val });

    // NEW: Add selected state
  document.querySelectorAll('.rateBtn').forEach(b => {
    b.classList.remove('selected');
    b.classList.add('dimmed');
  });
  btn.classList.remove('dimmed');
  btn.classList.add('selected');

  nextTestBtn.style.display = 'inline-block';
});




// Advance to next test or finish
nextTestBtn.addEventListener('click', () => {
  if (window.TTLOG) TTLOG.push('test_completed', { test_number: testIndex, turns: turnsThisTest });
  testIndex += 1;
  if (testIndex > TOTAL_TESTS) {
    if (window.TTLOG) TTLOG.push('tests_all_completed', { total: TOTAL_TESTS });
    // After finishing, you can auto-open the survey or simply hide the rating row
    ratingRow.style.display = 'none';
    // (leave user to click your existing "Finish & take survey" button)
  } else {
    setupTest();
  }
});

    // ----- Minimal chat wiring with accessibility & logging -----
    const messagesEl = document.getElementById('messages');
    const liveEl = document.getElementById('live');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const surveyBtn = document.getElementById('surveyBtn');
    const sessionPill = document.getElementById('sessionPill');

    function getSessionId(){
      try { return (JSON.parse(localStorage.getItem('tt_logs')||'{}').session_id)||''; }
      catch { return ''; }
    }
    function getDisc(){
      try { return (JSON.parse(localStorage.getItem('tt_meta')||'{}').disc)||''; }
      catch { return ''; }
    }
    function setSessionPill(){
      const id = getSessionId();
      const disc = getDisc();
      sessionPill.textContent = id ? `Session: ${id}${disc?` ‚Ä¢ Disc: ${disc}`:''}` : '';
    }

    function addMessage(role, content, {announce=false} = {}){
      const row = document.createElement('div');
      row.className = 'row ' + (role==='user' ? 'user' : 'assistant');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = content;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      if (role === 'assistant' && announce){
        // update polite live region for screen readers
        liveEl.textContent = content;
      }
    }

    function resetConversation(){
      messagesEl.innerHTML = '';
      addMessage(
        'assistant',
        "Hello! I'm the Taco Truck chatbot prototype.\n\n" +
        "I provide information only ‚Äî not legal advice.\n\n" +
        "How can I help you today?",
        {announce:true}
      );
      inputEl.value = '';
      inputEl.focus();
    }

   async function send(){
  const text = (inputEl.value||'').trim();
  if (!text) return;

  addMessage('user', text);
  if (window.TTLOG) TTLOG.push('chat_user_turn', { text: text, test_number: testIndex });

  inputEl.value = '';
  inputEl.focus();

  const row = document.createElement('div');
  row.className = 'row assistant';
  row.innerHTML = '<div class="bubble" style="display:flex;align-items:center;"><span class="spinner" aria-hidden="true"></span>Thinking‚Ä¶</div>';
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;

  const t0 = performance.now();
  try{
    const reply = await getReplyDemo(text);
    row.remove();
    addMessage('assistant', reply, {announce:true});
    const rt = Math.round(performance.now()-t0);
  if (window.TTLOG) TTLOG.push('chat_bot_turn', { 
    test_number: testIndex, 
    reply_text: reply 
});

    // Count a completed exchange on this test
    turnsThisTest += 1;
    maybeShowRating();

  }catch(err){
    row.remove();
    addMessage('assistant', 'Error: could not process your message.');
    if (window.TTLOG) TTLOG.push('chat_error', { message: String(err), test_number: testIndex });
  }
}


    // Keyboard & controls
    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', () => { resetConversation(); if (window.TTLOG) TTLOG.push('chat_cleared'); });
    inputEl.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    // Qualtrics hand-off (keeps your earlier behavior)
    surveyBtn.addEventListener('click', ()=>{
      const logs = JSON.parse(localStorage.getItem('tt_logs')||'{}');
      const meta = JSON.parse(localStorage.getItem('tt_meta')||'{}');
      const session = logs.session_id || '';
      const disc = meta.disc || '';
      const ts = new Date().toISOString();

      // (Optional explicit log) uncomment if you want a clear marker
      // if (window.TTLOG) TTLOG.push('survey_redirect', { session, disc });

      const base = 'https://ipaustralia.au1.qualtrics.com/jfe/form/SV_6g5ub3M5I2WGnf8';
      const url = `${base}?session_id=${encodeURIComponent(session)}&disc=${encodeURIComponent(disc)}&ts=${encodeURIComponent(ts)}`;
      window.location.href = url;
    });

    // Boot
    if (window.TTLOG) TTLOG.push('chat_start');
    // Compute time spent on disclaimer
(() => {
  try {
    const t0 = Number(localStorage.getItem('tt_disc_start') || '');
    if (t0) {
      const seconds = Math.round((Date.now() - t0) / 1000);
      if (window.TTLOG) TTLOG.push('disclaimer_complete', { seconds });
      localStorage.removeItem('tt_disc_start');
    }
  } catch (_) {}
})();

    window.addEventListener('beforeunload', ()=>{ if (window.TTLOG) TTLOG.push('chat_end'); });
    setSessionPill();
    loadTopics().then(() => setupTest());

  </script>
</body>
</html>
